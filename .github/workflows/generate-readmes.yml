name: Generate Sub-READMEs

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_run:      # å½“æ›´æ–°æ–‡ä»¶çš„é‚£ä¸ªå·¥ä½œæµå®Œæˆåè‡ªåŠ¨è¿è¡Œ
    workflows: ["Update File Test"]
    types:
      - completed

permissions:
  contents: write

jobs:
  generate-readmes:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: æ£€æŸ¥ä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: è¿è¡Œç”Ÿæˆè„šæœ¬
        run: |
          python3 -c '
          import os
          import urllib.parse

          # ä»“åº“åŸºç¡€é“¾æ¥
          REPO_URL = "https://github.com/${{ github.repository }}/blob/main"
          
          # æ–‡ä»¶å¤¹åç§°æ˜ å°„ï¼ˆè®©æ ‡é¢˜æ›´å‹å¥½ï¼‰
          DIR_MAP = {
              "Official_Examples": "Mihomo å®˜æ–¹ç¤ºä¾‹ (Official)",
              "General_Config": "é€šç”¨è¿›é˜¶é…ç½® (General Config)",
              "Smart_Mode": "Smart æ¨¡å¼ / è·¯ç”±ä¸“ç”¨ (Smart Mode)",
              "Mobile_Modules": "Android æ‰‹æœºæ¨¡å— (Mobile Modules)"
          }

          # å¿½ç•¥çš„æ–‡ä»¶å’Œç›®å½•
          IGNORE_DIRS = [".git", ".github"]
          IGNORE_FILES = ["README.md", "LICENSE"]

          def generate_readme(root_path, dirs, files):
              # è·å–ç›¸å¯¹è·¯å¾„
              rel_path = os.path.relpath(root_path, ".")
              if rel_path == ".": return

              # è·å–æ–‡ä»¶å¤¹åç§°
              folder_name = os.path.basename(root_path)
              
              # å°è¯•è·å–æ›´å‹å¥½çš„æ ‡é¢˜ï¼ˆå¦‚æœæ˜¯é¡¶çº§ç›®å½•ï¼‰
              display_title = DIR_MAP.get(folder_name, folder_name)

              # å‡†å¤‡ Markdown å†…å®¹
              content = []
              content.append(f"# ğŸ“‚ {display_title}\n")
              content.append("> è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ / Automatically generated file list.\n")
              
              # è®¡ç®—è¿”å›å±‚çº§ (ç”¨äºè¿”å›ä¸»é¡µé“¾æ¥)
              depth = rel_path.count(os.sep) + 1
              back_link = "../" * depth + "README.md"
              content.append(f"[ğŸ”™ è¿”å›ä¸»é¡µ (Return to Home)]({back_link})\n")
              
              content.append("## ğŸ“„ æ–‡ä»¶åˆ—è¡¨ (Files)\n")
              content.append("| æ–‡ä»¶å (Filename) | å¤§å° (Size) | åœ¨çº¿æŸ¥çœ‹ (Link) |")
              content.append("| :--- | :--- | :--- |")

              file_count = 0
              # éå†æ–‡ä»¶
              for file in sorted(files):
                  if file in IGNORE_FILES or file.startswith("."):
                      continue
                  
                  file_path = os.path.join(root_path, file)
                  file_url = f"{REPO_URL}/{urllib.parse.quote(rel_path)}/{urllib.parse.quote(file)}"
                  
                  # è·å–æ–‡ä»¶å¤§å°
                  size_bytes = os.path.getsize(file_path)
                  if size_bytes < 1024:
                      size_str = f"{size_bytes} B"
                  else:
                      size_str = f"{size_bytes / 1024:.1f} KB"

                  content.append(f"| **{file}** | {size_str} | [æŸ¥çœ‹é…ç½®]({file_url}) |")
                  file_count += 1

              # åªæœ‰å½“ç›®å½•ä¸‹æœ‰æ–‡ä»¶æ—¶æ‰å†™å…¥ README
              if file_count > 0:
                  with open(os.path.join(root_path, "README.md"), "w", encoding="utf-8") as f:
                      f.write("\n".join(content))
                  print(f"Generated README for: {rel_path}")

          # éå†ç›®å½•æ ‘
          for root, dirs, files in os.walk("."):
              # è¿‡æ»¤å¿½ç•¥çš„ç›®å½•
              dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
              
              generate_readme(root, dirs, files)
          '

      - name: æäº¤æ›´æ”¹
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add */**/README.md
          git commit -m "Docs: Auto-generate sub-folder READMEs" || echo "No changes to commit"
          
          git push origin HEAD:${{ github.ref_name }}
